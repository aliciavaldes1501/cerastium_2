---
title: 'Cerastium 2: Comparisons logger data, using all loggers'
output:
  pdf_document:
    toc: yes
    toc_depth: 4
  html_notebook:
    toc: yes
    toc_depth: '4'
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r load packages, include=FALSE}
library(tidyverse)
library(ggthemes)
library(knitr)
library(gridExtra)
library(DHARMa)
library(RColorBrewer)
library(broom)
library(ggpubr)
library(jtools)
library(kableExtra)
library(ggeffects)
library(MuMIn)
library(MASS)
library(segmented)
library(effects)
library(purrr)
library(lubridate)
library(ggforce)
library(car)
library(ggrepel)
```

```{r Define ggplot themes and palettes, include=FALSE}
my_theme <- function(){
  theme_base()+theme(plot.background=element_rect(fill="white", colour=NA))+
  theme(legend.position="none")+theme(text=element_text(family="serif"))+
  theme(plot.title = element_text(hjust =-0.06))
}
my_theme_legend <- function(){
  theme_base()+theme(plot.background=element_rect(fill="white", colour=NA))+
  theme(text=element_text(family="serif"))+
  theme(plot.title = element_text(hjust =-0.06))
}
myPalette <- colorRampPalette(brewer.pal(11, "YlOrRd"))
```

```{r, include=FALSE}
set_summ_defaults(digits = 3)
```

# Data preparation

Read list of all plants with temperature measured in 2018 (including Cerastium and other species):

```{r}
ids_temp_allsps<-read.table(
  "C:/Users/User/Dropbox/SU/Projects/cerastium_2/data/edited/ids_temp_allsps.csv",
  header=T,sep=",",dec=".") 
ids_temp_allsps$temp_term<-ids_temp_allsps$temp
ids_temp_allsps$temp<-NULL
head(ids_temp_allsps)
```

temp\_term = soil temperature measured with a thermometer at the time of marking in 2018, measured next to each plant at a depth of 10 cm.

Read list of plants with loggers (including Cerastium and other species):

```{r}
loggers<-read.table(
  "C:/Users/User/Dropbox/SU/Projects/cerastium_2/data/edited/ibuttons_AV_allsps.csv",
  header=T,sep=",",dec=".") 
head(loggers)
```

Merge both lists, keeping records in both lists (i.e. plants with temperature measured with thermometer and with a logger).

```{r message=FALSE, warning=FALSE}
temp_loggers<-ids_temp_allsps%>%
  inner_join(loggers)
head(temp_loggers)
```

```{r fig.height=3, fig.width=4}
ggplot(temp_loggers,aes(x=factor(above_below)))+geom_bar()
```

79 above and 143 below.

Import raw iButton data:

```{r}
all_logger_data <- list()
for(filename in list.files(
  "C:/Users/User/Dropbox/SU/Projects/cerastium_2/data/edited/RAW_iButton_data_to_use",
  full.names=T)) {
   all_logger_data[[length(all_logger_data) + 1]] <- read.table(filename,
                                                header=T,fill=T,sep=",",dec=",",skip=14) 
   all_logger_data[[length(all_logger_data)]]$logger_nr <-substr(filename,
                                                                 start=83,stop=100)
}
logger_data <- do.call(rbind, all_logger_data)%>%
  rownames_to_column("datetime")%>%
  rename(unit=Date.Time,value_int=Unit,value_dec=Value)
logger_data<-logger_data[c(1,3:5)]%>%
  mutate(temp=as.numeric(ifelse(is.na(value_dec),
                                value_int,
                                paste(value_int,value_dec,sep="."))))
logger_data<-logger_data[c(1,4:5)]%>%
  mutate(datetime=as.POSIXct(logger_data$datetime,
                             format="%d.%m.%Y %H:%M:%S",tz=Sys.timezone()))
logger_data<-logger_data%>%
  mutate(datetime=datetime %m+% years(1))%>%
  # Add one year to dates, as they were wrong - CHECK SOME CASES WERE NOT!
  mutate(logger_nr=as.numeric(gsub(".csv","",logger_nr)))

# Read individually some files that gave problems
log339<-read.table("C:/Users/User/Dropbox/SU/Projects/cerastium_2/data/edited/RAW_iButton_data_to_use_problematic/339.csv",
           header=T,fill=T,sep=",",dec=",",skip=14)
log344<-read.table("C:/Users/User/Dropbox/SU/Projects/cerastium_2/data/edited/RAW_iButton_data_to_use_problematic/344.csv",
           header=T,fill=T,sep=",",dec=",",skip=14)
log352<-read.table("C:/Users/User/Dropbox/SU/Projects/cerastium_2/data/edited/RAW_iButton_data_to_use_problematic/352.csv",
           header=T,fill=T,sep=",",dec=",",skip=14)
log383<-read.table("C:/Users/User/Dropbox/SU/Projects/cerastium_2/data/edited/RAW_iButton_data_to_use_problematic/383.csv",
           header=T,fill=T,sep=",",dec=",",skip=14)
log431<-read.table("C:/Users/User/Dropbox/SU/Projects/cerastium_2/data/edited/RAW_iButton_data_to_use_problematic/431.csv",
           header=T,fill=T,sep=",",dec=",",skip=14)
log585<-read.table("C:/Users/User/Dropbox/SU/Projects/cerastium_2/data/edited/RAW_iButton_data_to_use_problematic/585.csv",
           header=T,fill=T,sep=",",dec=",",skip=14)
log641<-read.table("C:/Users/User/Dropbox/SU/Projects/cerastium_2/data/edited/RAW_iButton_data_to_use_problematic/641.csv",
           header=T,fill=T,sep=",",dec=",",skip=14)
log654<-read.table("C:/Users/User/Dropbox/SU/Projects/cerastium_2/data/edited/RAW_iButton_data_to_use_problematic/654.csv",
           header=T,fill=T,sep=",",dec=",",skip=14)
log663<-read.table("C:/Users/User/Dropbox/SU/Projects/cerastium_2/data/edited/RAW_iButton_data_to_use_problematic/663.csv",
           header=T,fill=T,sep=",",dec=",",skip=14)
log339$logger_nr<-339
log344$logger_nr<-344
log352$logger_nr<-352
log383$logger_nr<-383
log431$logger_nr<-431
log585$logger_nr<-585
log641$logger_nr<-641
log654$logger_nr<-654
log663$logger_nr<-663

logger_data_problematic<-rbind(log339,log344,log352,log383,log431,
                               log585,log641,log654,log663)
logger_data_problematic<-logger_data_problematic%>%
  rename(datetime=Date.Time)%>%
   mutate(temp=as.numeric(ifelse(is.na(value_dec),
                                value_int,
                                paste(value_int,value_dec,sep="."))))
logger_data_problematic<-logger_data_problematic[c(1,5:6)]%>%
  mutate(datetime=as.POSIXct(logger_data_problematic$datetime,
                             format="%d.%m.%Y %H:%M:%S",
                             tz=Sys.timezone()))%>%
  mutate(datetime=datetime %m+% years(1))
  # Add one year to dates, as they were wrong - CHECK SOME CASES WERE NOT!

logger_data<-rbind(logger_data,logger_data_problematic)%>%
  inner_join(temp_loggers)
head(logger_data) 
```

```{r}
nrow(subset(logger_data,is.na(datetime)))
```

There are some NAs for datetime (70 rows - it seems that they were not able to be converted to POSIXct) --\> We can live with those

# Plot with all logger data, one line per logger id

```{r fig.height=5, fig.width=8}
ggplot(logger_data,aes(x=datetime,y=temp,group=logger_nr))+
  geom_line(size=0.1)
```

<!-- # Differences in mean temperatures for above and belowground loggers -->

<!-- ## Logger data for the whole period -->

<!-- All logger data, one line per logger id, colored by location (above/belowground) -->

<!-- ```{r fig.height=5, fig.width=8} -->

<!-- ggplot(logger_data,aes(x=datetime,y=temp,group=logger_nr, -->

<!--                        color=above_below))+ -->

<!--   geom_line(size=0.1) -->

<!-- ``` -->

<!-- ```{r} -->

<!-- logger_data$facet <- paste(logger_data$logger_nr,logger_data$temp_term,sep="\n")  -->

<!-- ``` -->

<!-- All logger data, one line per logger id, colored by location (above/belowground), plotted separately for loggers in control (C) and heated (H) plots: -->

<!-- ```{r fig.height=5, fig.width=8} -->

<!-- ggplot(logger_data,aes(x=datetime,y=temp,group=logger_nr, -->

<!--                        color=above_below))+ -->

<!--   geom_line(size=0.1)+facet_wrap(~plot_type) -->

<!-- ``` -->

<!-- For each date, mean temperature for all loggers, colored by location (above/belowground), plotted separately for loggers in control (C) and heated (H) plots: -->

<!-- ```{r fig.height=5, fig.width=8, message=FALSE, warning=FALSE} -->

<!-- logger_data%>% -->

<!--   mutate(date=date(datetime))%>% -->

<!--   group_by(date,above_below,plot_type)%>% -->

<!--   summarise(mean = mean(temp,na.rm=T),sd = sd(temp,na.rm=T), -->

<!--             n = n(),se = sd / n) %>% -->

<!--   ggplot(.,aes(x=date,y=mean,color=above_below))+ -->

<!--   geom_line(size=0.1)+facet_wrap(~plot_type)+ -->

<!--   geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.2, -->

<!--                  position=position_dodge(0.05))+ -->

<!--   ylab("Mean temperature (all loggers)") -->

<!-- ``` -->

<!-- How to test if above and belowground temperatures are more different in heated than in control plots? -->

<!-- What I have done: For each date, I calculated the absolute difference in means for above and belowground loggers (plotted below): -->

<!-- ```{r message=FALSE, warning=FALSE} -->

<!-- logger_data%>% -->

<!--   mutate(date=date(datetime))%>% -->

<!--   group_by(date,logger_nr)%>% -->

<!--   summarise(temp_date=mean(temp,na.rm=T), -->

<!--             plot_type=first(plot_type),above_below=first(above_below))%>% -->

<!--   group_by(date,above_below,plot_type)%>% -->

<!--   summarise(mean_temp=mean(temp_date,na.rm=T))%>% -->

<!--   pivot_wider(names_from=above_below,values_from=mean_temp)%>% -->

<!--   mutate(dif=abs(A-B))%>% -->

<!--   ggplot(.,aes(x=date,y=dif))+geom_line(size=0.1)+facet_wrap(~plot_type)+ -->

<!--   ylab("Absolute difference in means\nbetween above and belowground loggers") -->

<!-- ``` -->

<!-- I then tested for an effect of plot type (control or heated) on this difference: -->

<!-- ```{r message=FALSE, warning=FALSE} -->

<!-- logger_data%>% -->

<!--   mutate(date=date(datetime))%>% -->

<!--   group_by(date,logger_nr)%>% -->

<!--   summarise(temp_date=mean(temp,na.rm=T), -->

<!--             plot_type=first(plot_type),above_below=first(above_below))%>% -->

<!--   group_by(date,above_below,plot_type)%>% -->

<!--   summarise(mean_temp=mean(temp_date,na.rm=T))%>% -->

<!--   pivot_wider(names_from=above_below,values_from=mean_temp)%>% -->

<!--   mutate(dif=abs(A-B))%>% -->

<!--   lm(dif~plot_type,.)%>% -->

<!--   summ(.) -->

<!-- ``` -->

<!-- And found that the difference is indeed larger in heated plots. -->

<!-- Can you think of a better way to test this statistically? -->

<!-- ## Logger data for period April-May-June -->

<!-- The same plot with data from 1st April only, to look at soil and air temperatures in spring: -->

<!-- ```{r fig.height=5, fig.width=8} -->

<!-- logger_data%>% -->

<!--   mutate(month = month(datetime)) %>% -->

<!--   filter(month==4|month==5|month==6)%>% -->

<!--   ggplot(.,aes(x=datetime,y=temp,group=logger_nr,color=above_below))+ -->

<!--   geom_line(size=0.1)+facet_wrap(~plot_type) -->

<!-- ``` -->

<!-- For each date, mean temperature for all loggers, colored by location (above/belowground), plotted separately for loggers in control (C) and heated (H) plots: -->

<!-- ```{r fig.height=5, fig.width=8, message=FALSE, warning=FALSE} -->

<!-- logger_data%>% -->

<!--   mutate(month = month(datetime)) %>% -->

<!--   filter(month==4|month==5|month==6)%>% -->

<!--   mutate(date=date(datetime))%>% -->

<!--   group_by(date,above_below,plot_type)%>% -->

<!--   summarise(mean = mean(temp,na.rm=T),sd = sd(temp,na.rm=T), -->

<!--             n = n(),se = sd / n) %>% -->

<!--   ggplot(.,aes(x=date,y=mean,color=above_below))+ -->

<!--   geom_line(size=0.1)+facet_wrap(~plot_type)+ -->

<!--   geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.2, -->

<!--                  position=position_dodge(0.05))+ -->

<!--   ylab("Mean temperature (all loggers)") -->

<!-- ``` -->

<!-- Absolute difference in means for above and belowground loggers: -->

<!-- ```{r message=FALSE, warning=FALSE} -->

<!-- logger_data%>% -->

<!--   mutate(month = month(datetime)) %>% -->

<!--   filter(month==4|month==5|month==6)%>% -->

<!--   mutate(date=date(datetime))%>% -->

<!--   group_by(date,logger_nr)%>% -->

<!--   summarise(temp_date=mean(temp,na.rm=T), -->

<!--             plot_type=first(plot_type),above_below=first(above_below))%>% -->

<!--   group_by(date,above_below,plot_type)%>% -->

<!--   summarise(mean_temp=mean(temp_date,na.rm=T))%>% -->

<!--   pivot_wider(names_from=above_below,values_from=mean_temp)%>% -->

<!--   mutate(dif=abs(A-B))%>% -->

<!--   ggplot(.,aes(x=date,y=dif))+geom_line(size=0.1)+facet_wrap(~plot_type)+ -->

<!--   ylab("Absolute difference in means\nbetween above and belowground loggers") -->

<!-- ``` -->

<!-- Test for an effect of plot type (control or heated) on this difference: -->

<!-- ```{r message=FALSE, warning=FALSE} -->

<!-- logger_data%>% -->

<!--   mutate(month = month(datetime)) %>% -->

<!--   filter(month==4|month==5|month==6)%>% -->

<!--   mutate(date=date(datetime))%>% -->

<!--   group_by(date,logger_nr)%>% -->

<!--   summarise(temp_date=mean(temp,na.rm=T), -->

<!--             plot_type=first(plot_type),above_below=first(above_below))%>% -->

<!--   group_by(date,above_below,plot_type)%>% -->

<!--   summarise(mean_temp=mean(temp_date,na.rm=T))%>% -->

<!--   pivot_wider(names_from=above_below,values_from=mean_temp)%>% -->

<!--   mutate(dif=abs(A-B))%>% -->

<!--   lm(dif~plot_type,.)%>% -->

<!--   summ(.) -->

<!-- ``` -->

<!-- The difference is also larger in heated plots when considering only the period April-May-June. -->

<!-- ## Logger data for period April-May-June, each month separately -->

<!-- The same plot, plotted separately for each month (4=April, 5=May and 6=June): -->

<!-- ```{r fig.height=6, fig.width=10} -->

<!-- logger_data%>% -->

<!--   mutate(month = month(datetime)) %>% -->

<!--   filter(month==4|month==5|month==6)%>% -->

<!--   ggplot(.,aes(x=datetime,y=temp,group=logger_nr,color=above_below))+ -->

<!--   geom_line(size=0.1)+facet_wrap(~plot_type+month,scales="free") -->

<!-- ``` -->

<!-- For each date, mean temperature for all loggers, colored by location (above/belowground), plotted separately for loggers in control (C) and heated (H) plots: -->

<!-- ```{r fig.height=5, fig.width=8, message=FALSE, warning=FALSE} -->

<!-- logger_data%>% -->

<!--   mutate(month = month(datetime)) %>% -->

<!--   filter(month==4|month==5|month==6)%>% -->

<!--   mutate(date=date(datetime))%>% -->

<!--   group_by(date,month,above_below,plot_type)%>% -->

<!--   summarise(mean = mean(temp,na.rm=T),sd = sd(temp,na.rm=T), -->

<!--             n = n(),se = sd / n) %>% -->

<!--   ggplot(.,aes(x=date,y=mean,color=above_below))+ -->

<!--   geom_line(size=0.1)+facet_wrap(~plot_type)+ -->

<!--   geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.2, -->

<!--                  position=position_dodge(0.05))+ -->

<!--   facet_wrap(~plot_type+month,scales="free")+ -->

<!--   ylab("Mean temperature (all loggers)") -->

<!-- ``` -->

<!-- Absolute difference in means for above and belowground loggers: -->

<!-- ```{r message=FALSE, warning=FALSE} -->

<!-- logger_data%>% -->

<!--   mutate(month = month(datetime)) %>% -->

<!--   filter(month==4|month==5|month==6)%>% -->

<!--   mutate(date=date(datetime))%>% -->

<!--   group_by(date,logger_nr)%>% -->

<!--   summarise(temp_date=mean(temp,na.rm=T), -->

<!--             plot_type=first(plot_type),above_below=first(above_below))%>% -->

<!--   mutate(month=month(date))%>% -->

<!--   group_by(date,month,above_below,plot_type)%>% -->

<!--   summarise(mean_temp=mean(temp_date,na.rm=T))%>% -->

<!--   pivot_wider(names_from=above_below,values_from=mean_temp)%>% -->

<!--   mutate(dif=abs(A-B))%>% -->

<!--   ggplot(.,aes(x=date,y=dif))+geom_line(size=0.1)+ -->

<!--   facet_wrap(~plot_type+month,scales="free_x")+ -->

<!--   ylab("Absolute difference in means\nbetween above and belowground loggers") -->

<!-- ``` -->

<!-- ```{r message=FALSE, warning=FALSE} -->

<!-- logger_data%>% -->

<!--   mutate(month = month(datetime)) %>% -->

<!--   filter(month==4|month==5|month==6)%>% -->

<!--   mutate(date=date(datetime))%>% -->

<!--   group_by(date,logger_nr)%>% -->

<!--   summarise(temp_date=mean(temp,na.rm=T), -->

<!--             plot_type=first(plot_type),above_below=first(above_below))%>% -->

<!--   mutate(month=month(date))%>% -->

<!--   group_by(date,month,above_below,plot_type)%>% -->

<!--   summarise(mean_temp=mean(temp_date,na.rm=T))%>% -->

<!--   pivot_wider(names_from=above_below,values_from=mean_temp)%>% -->

<!--   mutate(dif=abs(A-B))%>% -->

<!--   group_by(month)%>% -->

<!--   do(fitmonth = tidy(lm(dif~plot_type, data = .))) %>%  -->

<!--   unnest(fitmonth)%>% -->

<!--   kable() -->

<!-- ``` -->

<!-- The difference is larger in heated plots in April and May, but not in june, where plot_type does not have a significant effect (but note that there are very few dates recorded in control plots in June, see graph above). -->

# Q1: Are instantaneous measures of soil temperature representative for the conditions during the entire spring/growing season?

Correlations logger temperature - instant temperature

## May

For each logger\_nr, get mean temperature during May 2017 and compare with temp\_term (which was measured with a thermometer at 10 cm depth on May 2017):

```{r message=FALSE, warning=FALSE, fig.height=3, fig.width=5}
maytemps<-logger_data%>%
  mutate(month = month(datetime)) %>%
  filter(month==5)%>%
  group_by(logger_nr) %>%
  summarize(meanmay_logger=mean(temp),temp_term=mean(temp_term),
            above_below=first(above_below))
ggplot(maytemps,aes(x=temp_term,y=meanmay_logger,color=above_below))+
  geom_point(size=0.5)+geom_smooth(method="lm",size=0.5)+
  geom_abline(lty="dashed",alpha=0.8)+
  xlab("Soil temperature (10 cm depth) measured in May")+
  ylab("Mean temperature of May\nfrom logger data")+
  scale_color_manual(name="Location",values=c("#F8766D", "#00BFC4"),
                     labels = c("Above, slope=0.04","Below, slope=0.85"))
summ(lm(meanmay_logger~temp_term,subset(maytemps,above_below=="A")))
summ(lm(meanmay_logger~temp_term,subset(maytemps,above_below=="B")))
```

Correlation mean temperature of may from logger data and soil temperature measured in may with thermometer:

```{r}
with(maytemps,cor(meanmay_logger,temp_term))
```

Correlation mean temperature of may from logger data (only belowground loggers) and soil temperature measured in may with thermometer:

```{r}
with(subset(maytemps,above_below=="B"),cor(meanmay_logger,temp_term))
```

Correlation mean temperature of may from logger data (only aboveground loggers) and soil temperature measured in may with thermometer:

```{r}
with(subset(maytemps,above_below=="A"),cor(meanmay_logger,temp_term))
```

## Whole period

For each logger\_nr, get mean temperature during the whole period available and compare with temp\_term (which was measured with a thermometer at 10 cm depth on May 2017):

```{r message=FALSE, warning=FALSE, fig.height=3, fig.width=5}
alltemps<-logger_data%>%
  group_by(logger_nr) %>%
  summarize(mean_logger=mean(temp),temp_term=mean(temp_term),
            above_below=first(above_below))
ggplot(alltemps,aes(x=temp_term,y=mean_logger,color=above_below))+
  geom_point(size=0.5)+geom_smooth(method="lm",size=0.5)+
  geom_abline(lty="dashed",alpha=0.8)+
  xlab("Soil temperature (10 cm depth) measured in May")+
  ylab("Mean temperature\nfrom logger data (whole period)")+
  scale_color_manual(name="Location",values=c("#F8766D", "#00BFC4"),
                     labels = c("Above, slope=0.07","Below, slope=0.83"))
summ(lm(mean_logger~temp_term,subset(alltemps,above_below=="A")))
summ(lm(mean_logger~temp_term,subset(alltemps,above_below=="B")))
```

Correlation mean temperature from logger data and soil temperature measured in may with thermometer:

```{r}
with(alltemps,cor(mean_logger,temp_term))
```

Correlation mean temperature from logger data (only belowground loggers) and soil temperature measured in may with thermometer:

```{r}
with(subset(alltemps,above_below=="B"),cor(mean_logger,temp_term))
```

Correlation mean temperature from logger data (only aboveground loggers) and soil temperature measured in may with thermometer:

```{r}
with(subset(alltemps,above_below=="A"),cor(mean_logger,temp_term))
```

The correlation values seem to indicate that the temperature measured with a thermometer represents quite well longer-term conditions

# Q2: Do differences between soil and air temperatures change with soil temperature?

For the plants with aboveground loggers, we have air temperature and soil temperature measured at the same exact location (air temperature measured by the aboveground logger and soil temperature measured with the thermometer). We use these plants to test for correlations between air and soil temperature.

## All temperature values

### Logger data for the whole period:

```{r message=FALSE, warning=FALSE, fig.height=3, fig.width=4}
logger_data%>%
  filter(above_below=="A")%>%
  group_by(logger_nr) %>%
  summarize(mean_logger=mean(temp),temp_term=mean(temp_term))%>%
  ggplot(.,aes(x=temp_term,y=mean_logger))+
  geom_point(size=0.5)+
  geom_smooth(method="lm",size=0.5)+
  geom_abline(lty="dashed",alpha=0.8)+
  xlab("Soil temperature (10 cm depth) measured in May")+
  ylab("Air temperature = Mean temperature\nfrom aboveground logger data\n(whole period)")
logger_data%>%
  filter(above_below=="A")%>%
  group_by(logger_nr) %>%
  summarize(mean_logger=mean(temp),temp_term=mean(temp_term))%>%
  lm(mean_logger~temp_term, data = .) %>%
  summ(.)
logger_data%>%
  filter(above_below=="A")%>%
  group_by(logger_nr) %>%
  summarize(mean_logger=mean(temp),temp_term=mean(temp_term))%>%
  lm(mean_logger~temp_term, data = .) %>%
  linearHypothesis(., "temp_term = 1")
```

The slope is significantly different from 1: differences between soil and air temperature change with soil temperature, being larger at higher soil temperatures.

### Logger data for May:

```{r message=FALSE, warning=FALSE, fig.height=3, fig.width=4}
logger_data%>%
  filter(above_below=="A")%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
  group_by(logger_nr) %>%
  summarize(meanmay_logger=mean(temp),temp_term=mean(temp_term))%>%
  ggplot(.,aes(x=temp_term,y=meanmay_logger))+
  geom_point(size=0.5)+
  geom_smooth(method="lm",size=0.5)+
  geom_abline(lty="dashed",alpha=0.8)+
  xlab("Soil temperature (10 cm depth) measured in May")+
  ylab("Air temperature May = Mean\ntemperature of May from\naboveground logger data")
logger_data%>%
  filter(above_below=="A")%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
  group_by(logger_nr) %>%
  summarize(meanmay_logger=mean(temp),temp_term=mean(temp_term))%>%
  lm(meanmay_logger~temp_term, data = .) %>%
  summ(.)
logger_data%>%
  filter(above_below=="A")%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
  group_by(logger_nr) %>%
  summarize(meanmay_logger=mean(temp),temp_term=mean(temp_term))%>%
  lm(meanmay_logger~temp_term, data = .) %>%
  linearHypothesis(., "temp_term = 1")
```

When looking only at air temperature in May, the slope is also significantly different from 1: differences between soil and air temperature change with soil temperature, being larger at higher soil temperatures.

### Logger data for April-May-June:

```{r message=FALSE, warning=FALSE, fig.height=3, fig.width=4}
logger_data%>%
  filter(above_below=="A")%>%
  mutate(month = month(datetime))%>%
  filter(month==4|month==5|month==6)%>%
  group_by(logger_nr) %>%
  summarize(meanspring_logger=mean(temp),temp_term=mean(temp_term))%>%
  ggplot(.,aes(x=temp_term,y=meanspring_logger))+
  geom_point(size=0.5)+
  geom_smooth(method="lm",size=0.5)+
  geom_abline(lty="dashed",alpha=0.8)+
  xlab("Soil temperature (10 cm depth) measured in May")+
  ylab("Air temperature spring = Mean\ntemperature of April-May-June\nfrom aboveground logger data")
logger_data%>%
  filter(above_below=="A")%>%
  mutate(month = month(datetime))%>%
  filter(month==4|month==5|month==6)%>%
  group_by(logger_nr) %>%
  summarize(meanspring_logger=mean(temp),temp_term=mean(temp_term))%>%
  lm(meanspring_logger~temp_term, data = .) %>%
  summ(.)
logger_data%>%
  filter(above_below=="A")%>%
  mutate(month = month(datetime))%>%
  filter(month==4|month==5|month==6)%>%
  group_by(logger_nr) %>%
  summarize(meanspring_logger=mean(temp),temp_term=mean(temp_term))%>%
  lm(meanspring_logger~temp_term, data = .) %>%
  linearHypothesis(., "temp_term = 1")
```

When looking at air temperature in the period April-May-June, the slope is also significantly different from 1: differences between soil and air temperature change with soil temperature, being larger at higher soil temperatures.

## Daily temperature values

Repeat what was done above using only daily values of air temperature (after 8 am and before or equal to 8 pm).

### Logger data for the whole period:

```{r message=FALSE, warning=FALSE, fig.height=3, fig.width=4}
logger_data%>%
  filter(above_below=="A")%>%
  mutate(time=hour(datetime))%>%
  filter(time>8&time<=20)%>%
  group_by(logger_nr) %>%
  summarize(mean_logger=mean(temp),temp_term=mean(temp_term))%>%
  ggplot(.,aes(x=temp_term,y=mean_logger))+
  geom_point(size=0.5)+
  geom_smooth(method="lm",size=0.5)+
  geom_abline(lty="dashed",alpha=0.8)+
  xlab("Soil temperature (10 cm depth) measured in May")+
  ylab("Air temperature = Mean temperature\n(daily values) from aboveground\nlogger data (whole period)")
logger_data%>%
  filter(above_below=="A")%>%
  mutate(time=hour(datetime))%>%
  filter(time>8&time<=20)%>%
  group_by(logger_nr) %>%
  summarize(mean_logger=mean(temp),temp_term=mean(temp_term))%>%
  lm(mean_logger~temp_term, data = .) %>%
  summ(.)
logger_data%>%
  filter(above_below=="A")%>%
  mutate(time=hour(datetime))%>%
  filter(time>8&time<=20)%>%
  group_by(logger_nr) %>%
  summarize(mean_logger=mean(temp),temp_term=mean(temp_term))%>% 
  lm(mean_logger~temp_term, data = .) %>%
  linearHypothesis(., "temp_term = 1")
```

### Logger data for May:

```{r message=FALSE, warning=FALSE, fig.height=3, fig.width=4}
logger_data%>%
  filter(above_below=="A")%>%
  mutate(time=hour(datetime))%>%
  filter(time>8&time<=20)%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
  group_by(logger_nr) %>%
  summarize(meanmay_logger=mean(temp),temp_term=mean(temp_term))%>%
  ggplot(.,aes(x=temp_term,y=meanmay_logger))+
  geom_point(size=0.5)+
  geom_smooth(method="lm",size=0.5)+
  geom_abline(lty="dashed",alpha=0.8)+
  xlab("Soil temperature (10 cm depth) measured in May")+
  ylab("Air temperature May = Mean\ntemperature of May (daily values)\nfrom aboveground logger data")
logger_data%>%
  filter(above_below=="A")%>%
  mutate(time=hour(datetime))%>%
  filter(time>8&time<=20)%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
  group_by(logger_nr) %>%
  summarize(meanmay_logger=mean(temp),temp_term=mean(temp_term))%>%
  lm(meanmay_logger~temp_term, data = .) %>%
  summ(.)
logger_data%>%
  filter(above_below=="A")%>%
  mutate(time=hour(datetime))%>%
  filter(time>8&time<=20)%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
  group_by(logger_nr) %>%
  summarize(meanmay_logger=mean(temp),temp_term=mean(temp_term))%>%
  lm(meanmay_logger~temp_term, data = .) %>%
  linearHypothesis(., "temp_term = 1")
```

### Logger data for April-May-June:

```{r message=FALSE, warning=FALSE, fig.height=3, fig.width=4.5}
logger_data%>%
  filter(above_below=="A")%>%
  mutate(time=hour(datetime))%>%
  filter(time>8&time<=20)%>%
  mutate(month = month(datetime))%>%
  filter(month==4|month==5|month==6)%>%
  group_by(logger_nr) %>%
  summarize(meanspring_logger=mean(temp),temp_term=mean(temp_term))%>%
  ggplot(.,aes(x=temp_term,y=meanspring_logger))+
  geom_point(size=0.5)+
  geom_smooth(method="lm",size=0.5)+
  geom_abline(lty="dashed",alpha=0.8)+
  xlab("Soil temperature (10 cm depth) measured in May")+
  ylab("Air temperature spring = Mean\ntemperature of April-May-June\n(daily values) from\naboveground logger data")
logger_data%>%
  filter(above_below=="A")%>%
  mutate(time=hour(datetime))%>%
  filter(time>8&time<=20)%>%
  mutate(month = month(datetime))%>%
  filter(month==4|month==5|month==6)%>%
  group_by(logger_nr) %>%
  summarize(meanspring_logger=mean(temp),temp_term=mean(temp_term))%>%
  lm(meanspring_logger~temp_term, data = .) %>%
  summ(.)
logger_data%>%
  filter(above_below=="A")%>%
  mutate(time=hour(datetime))%>%
  filter(time>8&time<=20)%>%
  mutate(month = month(datetime))%>%
  filter(month==4|month==5|month==6)%>%
  group_by(logger_nr) %>%
  summarize(meanspring_logger=mean(temp),temp_term=mean(temp_term))%>%
  lm(meanspring_logger~temp_term, data = .) %>%
  linearHypothesis(., "temp_term = 1")
```

## Positive temperature values

### Logger data for the whole period:

```{r message=FALSE, warning=FALSE, fig.height=3, fig.width=4}
logger_data%>%
  filter(above_below=="A")%>%
  filter(temp>0)%>%
  group_by(logger_nr) %>%
  summarize(mean_logger=mean(temp),temp_term=mean(temp_term))%>%
  ggplot(.,aes(x=temp_term,y=mean_logger))+
  geom_point(size=0.5)+
  geom_smooth(method="lm",size=0.5)+
  geom_abline(lty="dashed",alpha=0.8)+
  xlab("Soil temperature (10 cm depth) measured in May")+
  ylab("Air temperature = Mean temperature\n(positive values) from aboveground\nlogger data (whole period)")
logger_data%>%
  filter(above_below=="A")%>%
  filter(temp>0)%>%
  group_by(logger_nr) %>%
  summarize(mean_logger=mean(temp),temp_term=mean(temp_term))%>%
  lm(mean_logger~temp_term, data = .) %>%
  summ(.)
logger_data%>%
  filter(above_below=="A")%>%
  filter(temp>0)%>%
  group_by(logger_nr) %>%
  summarize(mean_logger=mean(temp),temp_term=mean(temp_term))%>%  
  lm(mean_logger~temp_term, data = .) %>%
  linearHypothesis(., "temp_term = 1")
```

### Logger data for May:

```{r message=FALSE, warning=FALSE, fig.height=3, fig.width=4}
logger_data%>%
  filter(above_below=="A")%>%
  filter(temp>0)%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
  group_by(logger_nr) %>%
  summarize(meanmay_logger=mean(temp),temp_term=mean(temp_term))%>%
  ggplot(.,aes(x=temp_term,y=meanmay_logger))+
  geom_point(size=0.5)+
  geom_smooth(method="lm",size=0.5)+
  geom_abline(lty="dashed",alpha=0.8)+
  xlab("Soil temperature (10 cm depth) measured in May")+
  ylab("Air temperature May = Mean\ntemperature of May (positive values)\nfrom aboveground logger data")
logger_data%>%
  filter(above_below=="A")%>%
  filter(temp>0)%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
  group_by(logger_nr) %>%
  summarize(meanmay_logger=mean(temp),temp_term=mean(temp_term))%>%
  lm(meanmay_logger~temp_term, data = .) %>%
  summ(.)
logger_data%>%
  filter(above_below=="A")%>%
  filter(temp>0)%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
  group_by(logger_nr) %>%
  summarize(meanmay_logger=mean(temp),temp_term=mean(temp_term))%>%
  lm(meanmay_logger~temp_term, data = .) %>%
  linearHypothesis(., "temp_term = 1")  
```

### Logger data for April-May-June:

```{r message=FALSE, warning=FALSE, fig.height=3, fig.width=4}
logger_data%>%
  filter(above_below=="A")%>%
  filter(temp>0)%>%
  mutate(month = month(datetime))%>%
  filter(month==4|month==5|month==6)%>%
  group_by(logger_nr) %>%
  summarize(meanspring_logger=mean(temp),temp_term=mean(temp_term))%>%
  ggplot(.,aes(x=temp_term,y=meanspring_logger))+
  geom_point(size=0.5)+
  geom_smooth(method="lm",size=0.5)+
  geom_abline(lty="dashed",alpha=0.8)+
  xlab("Soil temperature (10 cm depth) measured in May")+
  ylab("Air temperature spring = Mean\ntemperature of April-May-June\n(positive values) from\naboveground logger data")
logger_data%>%
  filter(above_below=="A")%>%
  filter(temp>0)%>%
  mutate(month = month(datetime))%>%
  filter(month==4|month==5|month==6)%>%
  group_by(logger_nr) %>%
  summarize(meanspring_logger=mean(temp),temp_term=mean(temp_term))%>%
  lm(meanspring_logger~temp_term, data = .) %>%
  summ(.)  
logger_data%>%
  filter(above_below=="A")%>%
  filter(temp>0)%>%
  mutate(month = month(datetime))%>%
  filter(month==4|month==5|month==6)%>%
  group_by(logger_nr) %>%
  summarize(meanspring_logger=mean(temp),temp_term=mean(temp_term))%>%  
  lm(meanspring_logger~temp_term, data = .) %>%
  linearHypothesis(., "temp_term = 1")  
```

Similar results when using daily or positive temperature values.

# Q3: Do correlations between soil and air temperature vary with soil temperature?

Or: How useful soil temperature is as a cue for air temperature, i.e., as a cue for spring advancement?

## Option 1: use plots to calculate correlations between soil and air logger temperatures

### Correlations soil-air temperature over the whole period

For each date and plot, calculate mean, max and min of air and soil temperature (from, respectively, above and belowground loggers). Then, calculate the correlation coefficient for air and soil temperatures over the whole period (based on the number of dates where both air and soil temperatures are available). Finally, regress these correlation coefficients on mean soil temperature for each plot for the whole period.

```{r message=FALSE, warning=FALSE, fig.height=4, fig.width=6}
(logger_data%>%
  mutate(date=date(datetime))%>%
  filter(!is.na(date))%>%
  group_by(date,plot,above_below)%>%
  summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp))%>%
  pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
  group_by(plot)%>%
  summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
            corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
            corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"))%>%
   pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                names_to="measure",values_to="corr")%>%
  left_join(logger_data%>%
  filter(above_below=="B")%>%
  group_by(plot)%>%
  summarise(meansoiltemp=mean(temp))))%>%
  # NAs for plots H11 and H15 --> no Belowground loggers
  ggplot(.,aes(x=meansoiltemp,y=corr,color=measure))+geom_point()+
  geom_smooth(method="lm")+
  xlab("Plot mean soil temperature for the whole period")+
  ylab("Correlation coef. air-soil temperature\nover the whole period\n(based on plot daily mean/min/max temperatures)")+
  geom_label(data=. %>% filter(plot=="H17"),aes(label=plot),
             nudge_x=2)
```

For plot H17, the correlation values are negative. This is strange, and I thought that it could be due to an error in one of the loggers, but after removing all loggers in that particular plot one by one, and redoing the analysis, the results were similar.

Linear models testing the effect of soil temperature on correlations between soil and air temperature:

```{r message=FALSE, warning=FALSE}
(logger_data%>%
  mutate(date=date(datetime))%>%
  filter(!is.na(date))%>%
  group_by(date,plot,above_below)%>%
  summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp))%>%
  pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
  group_by(plot)%>%
  summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
            corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
            corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"))%>%
   pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                names_to="measure",values_to="corr")%>%
  left_join(logger_data%>%
  filter(above_below=="B")%>%
  group_by(plot)%>%
  summarise(meansoiltemp=mean(temp))))%>%
  group_by(measure)%>%
  do(fitcorr = tidy(lm(corr~meansoiltemp, data = .))) %>% 
  unnest(fitcorr)%>%
  kable()
```

Only significant for correlations based on max daily temperatures (p=0.04).

Graph with plot H17 removed:

```{r message=FALSE, warning=FALSE, fig.height=4, fig.width=6}
(logger_data%>%
  mutate(date=date(datetime))%>%
  filter(!is.na(date))%>%
  filter(plot!="H17")%>%
  group_by(date,plot,above_below)%>%
  summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp))%>%
  pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
  group_by(plot)%>%
  summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
            corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
            corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"))%>%
   pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                names_to="measure",values_to="corr")%>%
  left_join(logger_data%>%
  filter(above_below=="B")%>%
  group_by(plot)%>%
  summarise(meansoiltemp=mean(temp))))%>%
  # NAs for plots H11 and H15 --> no Belowground loggers
  ggplot(.,aes(x=meansoiltemp,y=corr,color=measure))+geom_point()+
  geom_smooth(method="lm")+
  xlab("Plot mean soil temperature for the whole period")+
  ylab("Correlation coef. air-soil temperature\nover the whole period\n(based on plot daily mean/min/max temperatures)")
```

The same models with plot H17 removed:

```{r message=FALSE, warning=FALSE}
(logger_data%>%
  mutate(date=date(datetime))%>%
  filter(!is.na(date))%>%
  filter(plot!="H17")%>%
  group_by(date,plot,above_below)%>%
  summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp))%>%
  pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
  group_by(plot)%>%
  summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
            corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
            corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"))%>%
   pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                names_to="measure",values_to="corr")%>%
  left_join(logger_data%>%
  filter(above_below=="B")%>%
  group_by(plot)%>%
  summarise(meansoiltemp=mean(temp))))%>%
  group_by(measure)%>%
  do(fitcorr = tidy(lm(corr~meansoiltemp, data = .))) %>% 
  unnest(fitcorr)%>%
  kable()
```

Higly significant for all correlations (either based on max, mean or min daily temperatures). This indicates that correlations between soil and air temperature over the whole period vary with soil temperature, being weaker when soil temperature is warmer. Soil temperature is less useful as a cue for air temperature (i.e. for spring advancement) in warmer (heated) areas.

Is it OK to remove plot H17? What could cause the negative correlations in this plot? See below for scatterplots of air vs. soil temperature for each of the plots (plots H11 and H15 missing because they do not have any belowground loggers), and for H17, which is the only one with a negative correlation:

```{r message=FALSE, warning=FALSE, fig.height=14, fig.width=12}
logger_data%>%
  mutate(date=date(datetime))%>%
  filter(!is.na(date))%>%
  group_by(date,plot,above_below)%>%
  summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp))%>%
  pivot_longer(cols=mean:min,names_to="measure",values_to="data")%>%
  pivot_wider(names_from=above_below,values_from=data)%>%
  ggplot(.,aes(x=B,y=A,color=measure))+geom_point(size=0.1)+
  geom_smooth(method="lm")+
  facet_wrap(~plot,scales="free",ncol=5)+
  xlab("Daily mean/min/max soil temperature")+
  ylab("Daily mean/min/max air temperature")+
  theme(legend.position="top")
```

```{r message=FALSE, warning=FALSE, fig.height=3.5, fig.width=4}
logger_data%>%
  mutate(date=date(datetime))%>%
  filter(!is.na(date))%>%
  group_by(date,plot,above_below)%>%
  summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp))%>%
  pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
  filter(plot=="H17")%>%
  ggplot(.,aes(x=mean_B,y=mean_A))+geom_point(size=1)+
  geom_smooth(method="lm")+
  ggtitle("Plot H17")+
  xlab("Daily mean soil temperature")+ylab("Daily mean air temperature")
```

### Correlations soil-air temperature over the period April-May-June

For each date and plot, calculate mean, max and min of air and soil temperature (from, respectively, above and belowground loggers). Then, calculate the correlation coefficient for air and soil temperatures over the period April-May-June. Finally, regress these correlation coefficients on mean soil temperature for each plot for the whole period.

```{r message=FALSE, warning=FALSE, fig.height=4, fig.width=6}
(logger_data%>%
  mutate(month = month(datetime))%>%
  filter(month==4|month==5|month==6)%>%
  mutate(date=date(datetime))%>%
  filter(!is.na(date))%>%
  group_by(date,plot,above_below)%>%
  summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp))%>%
  pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
  group_by(plot)%>%
  summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
            corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
            corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"))%>%
   pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                names_to="measure",values_to="corr")%>%
  left_join(logger_data%>%
  filter(above_below=="B")%>%
  group_by(plot)%>%
  summarise(meansoiltemp=mean(temp))))%>%
  # NAs for plots H11 and H15 --> no Belowground loggers
  ggplot(.,aes(x=meansoiltemp,y=corr,color=measure))+geom_point()+
  geom_smooth(method="lm")+
  xlab("Plot mean soil temperature for the whole period")+
  ylab("Correlation coef. air-soil temperature\nover April-May-June\n(based on plot daily mean/min/max temperatures)")
```

Several plots with negative correlations!

Linear models testing the effect of soil temperature on correlations between soil and air temperature:

```{r message=FALSE, warning=FALSE}
(logger_data%>%
  mutate(date=date(datetime))%>%
  mutate(month = month(datetime))%>%
  filter(month==4|month==5|month==6)%>% 
  filter(!is.na(date))%>%
  group_by(date,plot,above_below)%>%
  summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp))%>%
  pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
  group_by(plot)%>%
  summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
            corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
            corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"))%>%
   pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                names_to="measure",values_to="corr")%>%
  left_join(logger_data%>%
  filter(above_below=="B")%>%
  group_by(plot)%>%
  summarise(meansoiltemp=mean(temp))))%>%
  group_by(measure)%>%
  do(fitcorr = tidy(lm(corr~meansoiltemp, data = .))) %>% 
  unnest(fitcorr)%>%
  kable()
```

Only significant for correlations based on max daily temperatures (p=0.01).

### Correlations soil-air temperature for May only

For each date and plot, calculate mean, max and min of air and soil temperature (from, respectively, above and belowground loggers). Then, calculate the correlation coefficient for air and soil temperatures over the month of May. Finally, regress these correlation coefficients on mean soil temperature for each plot for the whole period.

```{r message=FALSE, warning=FALSE, fig.height=4, fig.width=6}
(logger_data%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
  mutate(date=date(datetime))%>%
  filter(!is.na(date))%>%
  group_by(date,plot,above_below)%>%
  summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp))%>%
  pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
  group_by(plot)%>%
  summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
            corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
            corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"))%>%
   pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                names_to="measure",values_to="corr")%>%
  left_join(logger_data%>%
  filter(above_below=="B")%>%
  group_by(plot)%>%
  summarise(meansoiltemp=mean(temp))))%>%
  # NAs for plots H11 and H15 --> no Belowground loggers
  ggplot(.,aes(x=meansoiltemp,y=corr,color=measure))+geom_point()+
  geom_smooth(method="lm")+
  xlab("Plot mean soil temperature for the whole period")+
  ylab("Correlation coef. air-soil temperature\nover May\n(based on plot daily mean/min/max temperatures)")
```

Several plots with negative correlations!

Linear models testing the effect of soil temperature on correlations between soil and air temperature:

```{r message=FALSE, warning=FALSE}
(logger_data%>%
  mutate(date=date(datetime))%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>% 
  filter(!is.na(date))%>%
  group_by(date,plot,above_below)%>%
  summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp))%>%
  pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
  group_by(plot)%>%
  summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
            corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
            corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"))%>%
   pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                names_to="measure",values_to="corr")%>%
  left_join(logger_data%>%
  filter(above_below=="B")%>%
  group_by(plot)%>%
  summarise(meansoiltemp=mean(temp))))%>%
  group_by(measure)%>%
  do(fitcorr = tidy(lm(corr~meansoiltemp, data = .))) %>% 
  unnest(fitcorr)%>%
  kable()
```

Only significant for correlations based on max daily temperatures (p\<0.01). See graph below:

```{r message=FALSE, warning=FALSE, fig.height=4, fig.width=5}
(logger_data%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
  mutate(date=date(datetime))%>%
  filter(!is.na(date))%>%
  group_by(date,plot,above_below)%>%
  summarise(max=max(temp))%>%
  pivot_wider(names_from="above_below",values_from="max")%>%
  group_by(plot)%>%
  summarise(corr_airsoil_max=cor(A,B,use="pairwise.complete.obs"))%>%
    left_join(logger_data%>%
  filter(above_below=="B")%>%
  group_by(plot)%>%
  summarise(meansoiltemp=mean(temp))))%>%
  # NAs for plots H11 and H15 --> no Belowground loggers
  ggplot(.,aes(x=meansoiltemp,y=corr_airsoil_max))+geom_point()+
  geom_smooth(method="lm")+
  xlab("Plot mean soil temperature for the whole period")+
  ylab("Correlation coef. air-soil temperature\nover May\n(based on plot daily MAX temperatures)")
```

## Option 2: try to pair loggers

Use this option!

Read coordinates and add to data:

```{r}
coords<-read.table(
  "C:/Users/User/Dropbox/SU/Projects/cerastium_2/data/edited/coords_AV.csv",
  header=T,sep=",",dec=".") 
logger_data<-logger_data%>%
  left_join(coords)
head(logger_data)
```

### Plot locations of loggers in each plot, calculate distance matrices and make pairs

For each plot, pair each aboveground logger with the closest belowground logger

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="HC1")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot HC1")+
  scale_y_continuous(breaks = seq(0,13,by=1)) +
  scale_x_continuous(breaks = seq(0,13,by=1)) +
  coord_fixed(ylim=c(0, 9),xlim=c(0, 12))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="HC1")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 103-105 and 104-101

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==103|logger_nr==105,1,
                     ifelse(logger_nr==104|logger_nr==101,2,NA)))%>%
  mutate(dist=ifelse(pair==1,0.51,
                     ifelse(pair==2,5.65,NA)))
```

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="HC2a")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot HC2a")+
  scale_y_continuous(breaks = seq(0,13,by=1)) +
  scale_x_continuous(breaks = seq(0,13,by=1)) +
  coord_fixed(ylim=c(0, 3),xlim=c(0, 9))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="HC2a")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 108-113 and 111-115

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==108|logger_nr==113,3,
                     ifelse(logger_nr==111|logger_nr==115,4,pair)))%>%
  mutate(dist=ifelse(pair==3,2.21,
                     ifelse(pair==4,3.90,dist)))
```

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="HC2b")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot HC2b")+
  scale_y_continuous(breaks = seq(0,13,by=1)) +
  scale_x_continuous(breaks = seq(0,13,by=1)) +
  coord_fixed(ylim=c(0, 5),xlim=c(0, 13))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="HC2b")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 122-117 and 119-123

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==122|logger_nr==117,5,
                     ifelse(logger_nr==119|logger_nr==123,6,pair)))%>%
  mutate(dist=ifelse(pair==5,4.47,
                     ifelse(pair==6,2.52,dist)))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="HC3")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot HC3")+
  scale_y_continuous(breaks = seq(0,13,by=1)) +
  scale_x_continuous(breaks = seq(0,13,by=1)) +
  coord_fixed(ylim=c(0, 3),xlim=c(0, 9))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="HC3")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 137-127, 138-133 and 136-124

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==137|logger_nr==127,7,
                     ifelse(logger_nr==138|logger_nr==133,8,
                            ifelse(logger_nr==136|logger_nr==124,9,pair))))%>%
  mutate(dist=ifelse(pair==7,0.35,
                     ifelse(pair==8,0.72,
                            ifelse(pair==9,0.22,dist))))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="HC4")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot HC4")+
  scale_y_continuous(breaks = seq(0,20,by=1)) +
  scale_x_continuous(breaks = seq(0,20,by=1)) +
  coord_fixed(ylim=c(0, 10),xlim=c(0, 20))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="HC4")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 139-152, 143-153 and 149-154

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==139|logger_nr==152,10,
                     ifelse(logger_nr==143|logger_nr==153,11,
                            ifelse(logger_nr==149|logger_nr==154,12,pair))))%>%
  mutate(dist=ifelse(pair==10,2.63,
                     ifelse(pair==11,0.51,
                            ifelse(pair==12,0.96,dist))))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="HC5")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot HC5")+
  scale_y_continuous(breaks = seq(0,20,by=1)) +
  scale_x_continuous(breaks = seq(0,20,by=1)) +
  coord_fixed(ylim=c(0, 7),xlim=c(0, 13))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="HC5")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 165-155, 166-160 and 168-163

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==165|logger_nr==155,13,
                     ifelse(logger_nr==166|logger_nr==160,14,
                            ifelse(logger_nr==168|logger_nr==163,15,pair))))%>%
  mutate(dist=ifelse(pair==13,1.47,
                     ifelse(pair==14,1.08,
                            ifelse(pair==15,1.35,dist))))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="HC6")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot HC6")+
  scale_y_continuous(breaks = seq(0,22,by=1)) +
  scale_x_continuous(breaks = seq(0,22,by=1)) +
  coord_fixed(ylim=c(0, 10),xlim=c(0, 20))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="HC6")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 205-169 and 209-202

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==205|logger_nr==169,16,
                     ifelse(logger_nr==209|logger_nr==202,17,pair)))%>%
  mutate(dist=ifelse(pair==16,1.30,
                     ifelse(pair==17,4.87,dist)))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="HC10")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot HC10")+
  scale_y_continuous(breaks = seq(0,22,by=1)) +
  scale_x_continuous(breaks = seq(0,22,by=1)) +
  coord_fixed(ylim=c(0, 7),xlim=c(0, 7))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="HC10")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 57-3, 71-20 and 58-28

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==57|logger_nr==3,18,
                     ifelse(logger_nr==71|logger_nr==20,19,
                            ifelse(logger_nr==58|logger_nr==28,20,pair))))%>%
  mutate(dist=ifelse(pair==18,1.27,
                     ifelse(pair==19,1.01,
                            ifelse(pair==20,1.34,dist))))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="HC7")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot HC7")+
  scale_y_continuous(breaks = seq(0,22,by=1)) +
  scale_x_continuous(breaks = seq(0,22,by=1)) +
  coord_fixed(ylim=c(0, 4),xlim=c(0, 13))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="HC7")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 220-212, 221-215 and 222-218

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==220|logger_nr==212,21,
                     ifelse(logger_nr==221|logger_nr==215,22,
                            ifelse(logger_nr==222|logger_nr==218,23,pair))))%>%
  mutate(dist=ifelse(pair==21,1.91,
                     ifelse(pair==22,1.41,
                            ifelse(pair==23,1.50,dist))))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="HC8")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot HC8")+
  scale_y_continuous(breaks = seq(0,22,by=1)) +
  scale_x_continuous(breaks = seq(0,22,by=1)) +
  coord_fixed(ylim=c(0, 6),xlim=c(0, 10))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="HC8")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 233-224, 234-232 and 237-230

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==233|logger_nr==224,24,
                     ifelse(logger_nr==234|logger_nr==232,25,
                            ifelse(logger_nr==237|logger_nr==230,26,pair))))%>%
  mutate(dist=ifelse(pair==24,2.60,
                     ifelse(pair==25,1.33,
                            ifelse(pair==26,1.10,dist))))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="HC09")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot HC09")+
  scale_y_continuous(breaks = seq(0,22,by=1)) +
  scale_x_continuous(breaks = seq(0,22,by=1)) +
  coord_fixed(ylim=c(0, 6),xlim=c(0, 20))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="HC09")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 249-238, 251-243 and 252-247

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==249|logger_nr==238,27,
                     ifelse(logger_nr==251|logger_nr==243,28,
                            ifelse(logger_nr==252|logger_nr==247,29,pair))))%>%
  mutate(dist=ifelse(pair==27,2.24,
                     ifelse(pair==28,2.55,
                            ifelse(pair==29,1.81,dist))))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H10")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H10")+
  scale_y_continuous(breaks = seq(-5,30,by=1)) +
  scale_x_continuous(breaks = seq(0,30,by=1)) +
  coord_fixed(ylim=c(-5, 8),xlim=c(0, 30))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="H10")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 261-258, 262-255 (same plant/location), 263-256 (same plant/location)

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==261|logger_nr==258,30,
                     ifelse(logger_nr==262|logger_nr==255,31,
                            ifelse(logger_nr==263|logger_nr==256,32,pair))))%>%
  mutate(dist=ifelse(pair==30,13.32,
                     ifelse(pair==31,0,
                            ifelse(pair==32,0,dist))))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H01")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H01")+
  scale_y_continuous(breaks = seq(0,22,by=1)) +
  scale_x_continuous(breaks = seq(0,22,by=1)) +
  coord_fixed(ylim=c(0, 8),xlim=c(0, 20))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="H01")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 273-266, 274-267 and 275-270

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==273|logger_nr==266,33,
                     ifelse(logger_nr==274|logger_nr==267,34,
                            ifelse(logger_nr==275|logger_nr==270,35,pair))))%>%
  mutate(dist=ifelse(pair==33,3.09,
                     ifelse(pair==34,1.84,
                            ifelse(pair==35,2.15,dist))))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H02")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H02")+
  scale_y_continuous(breaks = seq(0,22,by=1)) +
  scale_x_continuous(breaks = seq(0,22,by=1)) +
  coord_fixed(ylim=c(0, 10),xlim=c(0, 15))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="H02")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 287-279

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==287|logger_nr==279,36,pair))%>%
  mutate(dist=ifelse(pair==36,9.06,dist))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H03")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H03")+
  scale_y_continuous(breaks = seq(0,22,by=1)) +
  scale_x_continuous(breaks = seq(0,22,by=1)) +
  coord_fixed(ylim=c(0, 7),xlim=c(0, 12))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="H03")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 296-288, 297-289 and 298-290 (same locations/plants)

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==296|logger_nr==288,37,
                     ifelse(logger_nr==297|logger_nr==289,38,
                            ifelse(logger_nr==298|logger_nr==290,39,pair))))%>%
  mutate(dist=ifelse(pair==37,0,
                     ifelse(pair==38,0,
                            ifelse(pair==39,0,dist))))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H04")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H04")+
  scale_y_continuous(breaks = seq(-2,30,by=1)) +
  scale_x_continuous(breaks = seq(0,30,by=1)) +
  coord_fixed(ylim=c(-2, 7),xlim=c(0, 28))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="H04")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 306-300, 307-301 and 308-302

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==306|logger_nr==300,40,
                     ifelse(logger_nr==307|logger_nr==301,41,
                            ifelse(logger_nr==308|logger_nr==302,42,pair))))%>%
  mutate(dist=ifelse(pair==40,1.67,
                     ifelse(pair==41,4.04,
                            ifelse(pair==42,1.19,dist))))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H05")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H05")+
  scale_y_continuous(breaks = seq(0,30,by=1)) +
  scale_x_continuous(breaks = seq(0,30,by=1)) +
  coord_fixed(ylim=c(0, 6),xlim=c(0, 20))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="H05")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 319-310, 320-312 and 321-317

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==319|logger_nr==310,43,
                     ifelse(logger_nr==320|logger_nr==312,44,
                            ifelse(logger_nr==321|logger_nr==317,45,pair))))%>%
  mutate(dist=ifelse(pair==43,1.46,
                     ifelse(pair==44,1.32,
                            ifelse(pair==45,0.96,dist))))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H06")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H06")+
  scale_y_continuous(breaks = seq(0,30,by=1)) +
  scale_x_continuous(breaks = seq(0,30,by=1)) +
  coord_fixed(ylim=c(0, 6),xlim=c(0, 28))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="H06")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 331-323, 332-324 and 333-329

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==331|logger_nr==323,46,
                     ifelse(logger_nr==332|logger_nr==324,47,
                            ifelse(logger_nr==333|logger_nr==329,48,pair))))%>%
  mutate(dist=ifelse(pair==46,2.25,
                     ifelse(pair==47,2.39,
                            ifelse(pair==48,1.29,dist))))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H07")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H07")+
  scale_y_continuous(breaks = seq(0,30,by=1)) +
  scale_x_continuous(breaks = seq(0,30,by=1)) +
  coord_fixed(ylim=c(0, 3),xlim=c(0, 20))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="H07")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 344-334, 345-336 and 346-339

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==344|logger_nr==334,49,
                     ifelse(logger_nr==345|logger_nr==336,50,
                            ifelse(logger_nr==346|logger_nr==339,51,pair))))%>%
  mutate(dist=ifelse(pair==49,1.11,
                     ifelse(pair==50,1.48,
                            ifelse(pair==51,1.52,dist))))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H08")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H08")+
  scale_y_continuous(breaks = seq(0,30,by=1)) +
  scale_x_continuous(breaks = seq(0,30,by=1)) +
  coord_fixed(ylim=c(-1, 5),xlim=c(0, 21))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="H08")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 355-347, 356-349 and 357-352

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==355|logger_nr==347,52,
                     ifelse(logger_nr==356|logger_nr==349,53,
                            ifelse(logger_nr==357|logger_nr==352,54,pair))))%>%
  mutate(dist=ifelse(pair==52,1.24,
                     ifelse(pair==53,4.59,
                            ifelse(pair==54,3.54,dist))))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H09")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H09")+
  scale_y_continuous(breaks = seq(0,30,by=1)) +
  scale_x_continuous(breaks = seq(0,30,by=1)) +
  coord_fixed(ylim=c(0, 4),xlim=c(0, 20))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="H09")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 369-362, 370-366 and 371-367

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==369|logger_nr==362,55,
                     ifelse(logger_nr==370|logger_nr==366,56,
                            ifelse(logger_nr==371|logger_nr==367,57,pair))))%>%
  mutate(dist=ifelse(pair==55,2.55,
                     ifelse(pair==56,4.68,
                            ifelse(pair==57,1.19,dist))))
```

Plot H11 not included because there are only aboveground loggers

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H13")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H13")+
  scale_y_continuous(breaks = seq(0,30,by=1)) +
  scale_x_continuous(breaks = seq(0,30,by=1)) +
  coord_fixed(ylim=c(-1, 3),xlim=c(0, 11))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="H13")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 395-386 (same location/plant) and 396-391

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==395|logger_nr==386,58,
                     ifelse(logger_nr==396|logger_nr==391,59,pair)))%>%
  mutate(dist=ifelse(pair==58,0,
                     ifelse(pair==59,5.16,dist)))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H14")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H14")+
  scale_y_continuous(breaks = seq(0,30,by=1)) +
  scale_x_continuous(breaks = seq(0,30,by=1)) +
  coord_fixed(ylim=c(0,7),xlim=c(0, 9))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="H14")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 411-406, 408-397 and 415-407

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==411|logger_nr==406,60,
                     ifelse(logger_nr==408|logger_nr==397,61,
                            ifelse(logger_nr==415|logger_nr==407,62,pair))))%>%
  mutate(dist=ifelse(pair==60,1.50,
                     ifelse(pair==61,0,
                            ifelse(pair==62,3.45,dist))))
```

Plot H11 not included because there are only aboveground loggers

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H16")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H16")+
  scale_y_continuous(breaks = seq(0,30,by=1)) +
  scale_x_continuous(breaks = seq(0,30,by=1)) +
  coord_fixed(ylim=c(0, 12),xlim=c(0, 5))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="H16")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 458-559

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==458|logger_nr==559,63,pair))%>%
  mutate(dist=ifelse(pair==63,0,dist))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H17")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H17")+
  scale_y_continuous(breaks = seq(0,30,by=1)) +
  scale_x_continuous(breaks = seq(0,30,by=1)) +
  coord_fixed(ylim=c(0, 8),xlim=c(0, 9))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="H17")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 654-585, 655-588 and 656-599 (all same locations / plants)

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==654|logger_nr==588,64,
                     ifelse(logger_nr==655|logger_nr==588,65,
                            ifelse(logger_nr==656|logger_nr==599,66,pair))))%>%
  mutate(dist=ifelse(pair==64,0,
                     ifelse(pair==65,0,
                            ifelse(pair==66,0,dist))))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H18a")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H18a")+
  scale_y_continuous(breaks = seq(0,30,by=1)) +
  scale_x_continuous(breaks = seq(0,30,by=1)) +
  coord_fixed(ylim=c(0, 3),xlim=c(0, 25))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="H18a")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 663-659 and 664-662 (all same locations / plants)

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==663|logger_nr==659,67,
                     ifelse(logger_nr==664|logger_nr==662,68,pair)))%>%
  mutate(dist=ifelse(pair==67,0,
                     ifelse(pair==68,0,dist)))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H18b")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H18b")+
  scale_y_continuous(breaks = seq(0,30,by=1)) +
  scale_x_continuous(breaks = seq(0,30,by=1)) +
  coord_fixed(ylim=c(0, 3),xlim=c(0, 3))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="H18b")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 671-668 (same location / plant) and 670-666

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==671|logger_nr==668,69,
                     ifelse(logger_nr==670|logger_nr==666,70,pair)))%>%
  mutate(dist=ifelse(pair==69,0,
                     ifelse(pair==70,1.77,dist)))
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H19")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H19")+
  scale_y_continuous(breaks = seq(0,30,by=1)) +
  scale_x_continuous(breaks = seq(0,30,by=1)) +
  coord_fixed(ylim=c(0, 12),xlim=c(0, 4))
```

Distance matrix:

```{r message=FALSE, warning=FALSE}
logger_data%>%
  filter(plot=="H19")%>%
  group_by(logger_nr)%>%
  summarise(X=first(X),Y=first(Y))%>%
  column_to_rownames(var="logger_nr")%>%
  dist()%>%
  as.matrix()%>%
  # as.data.frame()%>%
  # rownames_to_column(var="logger_nr")%>%
  # pivot_longer(cols=-logger_nr,names_to="logger_nr_2",values_to="distance")
  round(digits=2)
```

Pairs: 683-675, 682-674, 681-673 (all same locations / plants)

```{r}
logger_data<-logger_data%>%
  mutate(pair=ifelse(logger_nr==683|logger_nr==675,71,
                     ifelse(logger_nr==682|logger_nr==674,72,
                            ifelse(logger_nr==681|logger_nr==673,73,pair))))%>%
  mutate(dist=ifelse(pair==71,0,
                     ifelse(pair==72,0,
                            ifelse(pair==73,0,dist))))
```

```{r}
logger_data_pairs<-subset(logger_data,!is.na(pair))
```

### Paired logger data

Plot with all paired logger data, one line per logger id

```{r fig.height=5, fig.width=8, message=FALSE, warning=FALSE}
ggplot(logger_data_pairs,aes(x=datetime,y=temp,group=logger_nr))+
  geom_line(size=0.1)+
  geom_vline(xintercept=as.numeric(logger_data_pairs$datetime[2044]), 
             linetype=3,color="red")
```
```{r}
logger_data_pairs%>%
  group_by(logger_nr)%>%
  summarise(pair=first(pair),last_date=last(datetime))%>%
  arrange(pair)
```

Most loggers (131 out of 145) end up on June 6th. So probably using May is OK.

### Analyses using all pairs

#### Correlations soil-air temperature over the period April-May-June

##### Based on 24-h values

For each date and logger pair, calculate mean, max and min of air and soil temperature (from, respectively, the above and belowground logger). Then, calculate the correlation coefficient for air and soil temperatures over the period April-May-June. Finally, regress these correlation coefficients on mean soil temperature (from the aboveground logger) **for the same period (April-May-June)**.

Using only data till June 5th, included (as most loggers stop on June 6th).

```{r message=FALSE, warning=FALSE, fig.height=4, fig.width=6}
(logger_data_pairs%>%
     mutate(month = month(datetime))%>%
     filter(month==4|month==5|month==6)%>%
     mutate(date=date(datetime))%>%
     filter(datetime<"2018-06-06")%>%
     filter(!is.na(date))%>%
     group_by(date,pair,above_below)%>%
     summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp),
               plot=first(plot))%>%
     pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
     group_by(pair)%>%
     summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
               corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
               corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"),
               plot=first(plot))%>%
     pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                  names_to="measure",values_to="corr")%>%
     left_join(logger_data_pairs%>%
                 mutate(month = month(datetime))%>%
                 filter(month==4|month==5|month==6)%>%
                 filter(datetime<"2018-06-06")%>%
                 filter(above_below=="B")%>%
                 group_by(pair)%>%
                 summarise(meansoiltemp=mean(temp),dist=first(dist))))%>%
  # NAs for plots H11 and H15 --> no Belowground loggers
  ggplot(.,aes(x=meansoiltemp,y=corr,color=measure))+geom_point()+
  geom_smooth(method="lm")+
  xlab("Mean soil temperature for April-May-June")+
  ylab("Correlation coef. air-soil temperature\nover April-May-June\n(based on daily mean/min/max temperatures)")+
  geom_text_repel(data=. %>% filter(corr<0),aes(label=pair))
```

###### Look at the pairs with negative correlations in detail

Pairs with negative correlations: 36 (only for min), 63, 66, 68, 71, 73.

```{r fig.height=5, fig.width=8, message=FALSE, warning=FALSE}
ggplot(logger_data_pairs%>%filter(pair==36)%>%
         mutate(month = month(datetime))%>%
         filter(month==4|month==5|month==6)%>%
         filter(datetime<"2018-06-06"),
       aes(x=datetime,y=temp,color=above_below))+
  geom_line(size=0.1)+ggtitle("Pair 36")
```

I cannot see anything worrying in the graph. As the negative correlation is only for the min temperature, and it is also not very negative, maybe there is nothing strange here?

```{r fig.height=5, fig.width=8, message=FALSE, warning=FALSE}
ggplot(logger_data_pairs%>%filter(pair==63)%>%
         mutate(month = month(datetime))%>%
         filter(month==4|month==5|month==6)%>%
         filter(datetime<"2018-06-06"),
       aes(x=datetime,y=temp,color=above_below))+
  geom_line(size=0.1)+ggtitle("Pair 63")
```

Here, both loggers have constant values of temperature for several periods of time.

The next graph shows all loggers in the same plot as pair 63:

```{r}
ggplot(logger_data%>%filter(plot=="H16")%>%
         mutate(month = month(datetime))%>%
         filter(month==4|month==5|month==6)%>%
         filter(datetime<"2018-06-06"),
       aes(x=datetime,y=temp,color=above_below))+
  geom_line(size=0.1)+ggtitle("Plot H16")+facet_wrap(~logger_nr)
```

All but one have similar patterns, with constant values for some time periods.

Here is the spatial distribution of the loggers in the plot:

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H16")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H16")+
  scale_y_continuous(breaks = seq(0,30,by=1)) +
  scale_x_continuous(breaks = seq(0,30,by=1)) +
  coord_fixed(ylim=c(0, 12),xlim=c(0, 5))
```

Maybe part of the plot was covered by snow, causing this low variation, and logger 503 was not?

```{r fig.height=5, fig.width=8, message=FALSE, warning=FALSE}
ggplot(logger_data_pairs%>%filter(pair==66)%>%
         mutate(month = month(datetime))%>%
         filter(month==4|month==5|month==6)%>%
         filter(datetime<"2018-06-06"),
       aes(x=datetime,y=temp,color=above_below))+
  geom_line(size=0.1)+ggtitle("Pair 66")
```

The next graph shows all loggers in the same plot as pair 66:

```{r}
ggplot(logger_data%>%filter(plot=="H17")%>%
         mutate(month = month(datetime))%>%
         filter(month==4|month==5|month==6)%>%
         filter(datetime<"2018-06-06"),
       aes(x=datetime,y=temp,color=above_below))+
  geom_line(size=0.1)+ggtitle("Plot H17")+facet_wrap(~logger_nr)
```

All the belowground loggers show similar patters, with very low variation. However, the aboveground loggers look fine, even if they are located at the same plant that a belowground logger (see locations in the graph below). So this is probably not due to effects of snow? Or could it be that the aboveground loggers are out of the snow but the belowground ones are covered by snow?

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H17")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H17")+
  scale_y_continuous(breaks = seq(0,30,by=1)) +
  scale_x_continuous(breaks = seq(0,30,by=1)) +
  coord_fixed(ylim=c(0, 8),xlim=c(0, 10))
```

```{r fig.height=5, fig.width=8, message=FALSE, warning=FALSE}
ggplot(logger_data_pairs%>%filter(pair==68)%>%
         mutate(month = month(datetime))%>%
         filter(month==4|month==5|month==6)%>%
         filter(datetime<"2018-06-06"),
       aes(x=datetime,y=temp,color=above_below))+
  geom_line(size=0.1)+ggtitle("Pair 68")
```

The next graph shows all loggers in the same plot as pair 68:

```{r}
ggplot(logger_data%>%filter(plot=="H18a")%>%
         mutate(month = month(datetime))%>%
         filter(month==4|month==5|month==6)%>%
         filter(datetime<"2018-06-06"),
       aes(x=datetime,y=temp,color=above_below))+
  geom_line(size=0.1)+ggtitle("Plot H18a")+facet_wrap(~logger_nr)
```

And the locations in the plot:

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H18a")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H18a")+
  scale_y_continuous(breaks = seq(0,30,by=1)) +
  scale_x_continuous(breaks = seq(0,30,by=1)) +
  coord_fixed(ylim=c(0, 3),xlim=c(0, 25))
```

And the locations in the plot:

```{r fig.height=5, fig.width=8, message=FALSE, warning=FALSE}
ggplot(logger_data_pairs%>%filter(pair==71)%>%
         mutate(month = month(datetime))%>%
         filter(month==4|month==5|month==6)%>%
         filter(datetime<"2018-06-06"),
       aes(x=datetime,y=temp,color=above_below))+
  geom_line(size=0.1)+ggtitle("Pair 71")
```
One can really see the negative correlation in this pair! The "peaks" for the aboveground logger coincide with the "valleys" for the belowground one. 

```{r fig.height=5, fig.width=8, message=FALSE, warning=FALSE}
ggplot(logger_data_pairs%>%filter(pair==73)%>%
         mutate(month = month(datetime))%>%
         filter(month==4)%>%
         filter(datetime<"2018-06-06"),
       aes(x=datetime,y=temp,color=above_below))+
  geom_line(size=0.1)+ggtitle("Pair 73")
```

The next graph shows all loggers in the same plot as pair 71 and 73:

```{r}
ggplot(logger_data%>%filter(plot=="H19")%>%
         mutate(month = month(datetime))%>%
         filter(month==4|month==5|month==6)%>%
         filter(datetime<"2018-06-06"),
       aes(x=datetime,y=temp,color=above_below))+
  geom_line(size=0.1)+ggtitle("Plot H19")+facet_wrap(~logger_nr)
```

```{r message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
logger_data%>%
  filter(plot=="H19")%>%
  group_by(plot,logger_nr,above_below)%>%
  summarise(X=first(X),Y=first(Y))%>%
  ggplot(aes(x=X,y=Y,color=above_below,label=logger_nr))+geom_point()+
  geom_text_repel()+ggtitle("Plot H19")+
  scale_y_continuous(breaks = seq(0,30,by=1)) +
  scale_x_continuous(breaks = seq(0,30,by=1)) +
  coord_fixed(ylim=c(0, 12),xlim=c(0, 4))
```

Linear models testing the effect of soil temperature on correlations between soil and air temperature:

```{r message=FALSE, warning=FALSE}
(logger_data_pairs%>%
     mutate(month = month(datetime))%>%
     filter(month==4|month==5|month==6)%>%
     mutate(date=date(datetime))%>%
     filter(datetime<"2018-06-06")%>%
     filter(!is.na(date))%>%
     group_by(date,pair,above_below)%>%
     summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp),
               plot=first(plot))%>%
     pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
     group_by(pair)%>%
     summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
               corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
               corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"),
               plot=first(plot))%>%
     pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                  names_to="measure",values_to="corr")%>%
  left_join(logger_data_pairs%>%
                 mutate(month = month(datetime))%>%
                 filter(month==4|month==5|month==6)%>%
                 filter(datetime<"2018-06-06")%>%
                 filter(above_below=="B")%>%
                 group_by(pair)%>%
              summarise(meansoiltemp=mean(temp),dist=first(dist))))%>%
  group_by(measure)%>%
  do(fitcorr = tidy(lm(corr~meansoiltemp, data = .))) %>% 
  unnest(fitcorr)%>%
  kable()
```

Non-significant in all cases.

##### Based on 12-h (day) values

Using only daily values of temperature (after 8 am and before or equal to 8 pm).

```{r message=FALSE, warning=FALSE, fig.height=4, fig.width=6}
(logger_data_pairs%>%
     mutate(month = month(datetime))%>%
     filter(month==4|month==5|month==6)%>%
     mutate(time=hour(datetime))%>%
     filter(time>8&time<=20)%>%
     mutate(date=date(datetime))%>%
     filter(datetime<"2018-06-06")%>%
     filter(!is.na(date))%>%
     group_by(date,pair,above_below)%>%
     summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp),
               plot=first(plot))%>%
     pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
     group_by(pair)%>%
     summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
               corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
               corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"),
               plot=first(plot))%>%
     pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                  names_to="measure",values_to="corr")%>%
     left_join(logger_data_pairs%>%
                 mutate(month = month(datetime))%>%
                 filter(month==4|month==5|month==6)%>%
                 mutate(time=hour(datetime))%>%
                 filter(time>10&time<=18)%>%
                 filter(datetime<"2018-06-06")%>%
                 filter(above_below=="B")%>%
                 group_by(pair)%>%
                 summarise(meansoiltemp=mean(temp),dist=first(dist))))%>%
  # NAs for plots H11 and H15 --> no Belowground loggers
  ggplot(.,aes(x=meansoiltemp,y=corr,color=measure))+geom_point()+
  geom_smooth(method="lm")+
  xlab("Mean soil temperature for April-May-June")+
  ylab("Correlation coef. air-soil temperature\nover April-May-June\n(based on daily mean/min/max temperatures)")+
  geom_text_repel(data=. %>% filter(corr<0),aes(label=pair))
```

Linear models testing the effect of soil temperature on correlations between soil and air temperature:

```{r message=FALSE, warning=FALSE}
(logger_data_pairs%>%
     mutate(month = month(datetime))%>%
     filter(month==4|month==5|month==6)%>%
   mutate(time=hour(datetime))%>%
     filter(time>8&time<=20)%>%
     mutate(date=date(datetime))%>%
     filter(datetime<"2018-06-06")%>%
     filter(!is.na(date))%>%
     group_by(date,pair,above_below)%>%
     summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp),
               plot=first(plot))%>%
     pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
     group_by(pair)%>%
     summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
               corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
               corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"),
               plot=first(plot))%>%
     pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                  names_to="measure",values_to="corr")%>%
  left_join(logger_data_pairs%>%
                 mutate(month = month(datetime))%>%
                 filter(month==4|month==5|month==6)%>%
              mutate(time=hour(datetime))%>%
     filter(time>8&time<=20)%>%
                 filter(datetime<"2018-06-06")%>%
                 filter(above_below=="B")%>%
                 group_by(pair)%>%
              summarise(meansoiltemp=mean(temp),dist=first(dist))))%>%
  group_by(measure)%>%
  do(fitcorr = tidy(lm(corr~meansoiltemp, data = .))) %>% 
  unnest(fitcorr)%>%
  kable()
```

Non-significant in all cases.

##### Based on positive values

Using only positive values of temperature (>0).

```{r message=FALSE, warning=FALSE, fig.height=4, fig.width=6}
(logger_data_pairs%>%
     mutate(month = month(datetime))%>%
     filter(month==4|month==5|month==6)%>%
     filter(temp>0)%>%
     mutate(date=date(datetime))%>%
     filter(datetime<"2018-06-06")%>%
     filter(!is.na(date))%>%
     group_by(date,pair,above_below)%>%
     summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp),
               plot=first(plot))%>%
     pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
     group_by(pair)%>%
     summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
               corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
               corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"),
               plot=first(plot))%>%
     pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                  names_to="measure",values_to="corr")%>%
     left_join(logger_data_pairs%>%
                 mutate(month = month(datetime))%>%
                 filter(month==4|month==5|month==6)%>%
                 filter(temp>0)%>%
                 filter(datetime<"2018-06-06")%>%
                 filter(above_below=="B")%>%
                 group_by(pair)%>%
                 summarise(meansoiltemp=mean(temp),dist=first(dist))))%>%
  # NAs for plots H11 and H15 --> no Belowground loggers
  ggplot(.,aes(x=meansoiltemp,y=corr,color=measure))+geom_point()+
  geom_smooth(method="lm")+
  xlab("Mean soil temperature for April-May-June")+
  ylab("Correlation coef. air-soil temperature\nover April-May-June\n(based on daily mean/min/max temperatures)")+
  geom_text_repel(data=. %>% filter(corr<0),aes(label=pair))
```

Linear models testing the effect of soil temperature on correlations between soil and air temperature:

```{r message=FALSE, warning=FALSE}
(logger_data_pairs%>%
     mutate(month = month(datetime))%>%
     filter(month==4|month==5|month==6)%>%
   filter(temp>0)%>%
     mutate(date=date(datetime))%>%
     filter(datetime<"2018-06-06")%>%
     filter(!is.na(date))%>%
     group_by(date,pair,above_below)%>%
     summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp),
               plot=first(plot))%>%
     pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
     group_by(pair)%>%
     summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
               corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
               corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"),
               plot=first(plot))%>%
     pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                  names_to="measure",values_to="corr")%>%
  left_join(logger_data_pairs%>%
                 mutate(month = month(datetime))%>%
                 filter(month==4|month==5|month==6)%>%
              filter(temp>0)%>%
                 filter(datetime<"2018-06-06")%>%
                 filter(above_below=="B")%>%
                 group_by(pair)%>%
              summarise(meansoiltemp=mean(temp),dist=first(dist))))%>%
  group_by(measure)%>%
  do(fitcorr = tidy(lm(corr~meansoiltemp, data = .))) %>% 
  unnest(fitcorr)%>%
  kable()
```

Significant for min only.

#### Correlations soil-air temperature for May only

##### Based on 24-h values

For each date and logger pair, calculate mean, max and min of air and soil temperature (from, respectively, the above and belowground logger). Then, calculate the correlation coefficient for air and soil temperatures over the month of May. Finally, regress these correlation coefficients on mean soil temperature (from the aboveground logger) **for the same period (May)**.

```{r message=FALSE, warning=FALSE, fig.height=4, fig.width=6}
(logger_data_pairs%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
  mutate(date=date(datetime))%>%
  filter(!is.na(date))%>%
  group_by(date,pair,above_below)%>%
  summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp),
               plot=first(plot))%>%
  pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
  group_by(pair)%>%
  summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
            corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
            corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"),
            plot=first(plot))%>%
   pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                names_to="measure",values_to="corr")%>%
  left_join(logger_data_pairs%>%
              mutate(month = month(datetime))%>%
              filter(month==5)%>%
              filter(above_below=="B")%>%
              group_by(pair)%>%
              summarise(meansoiltemp=mean(temp),dist=first(dist))))%>%
  # NAs for plots H11 and H15 --> no Belowground loggers
  ggplot(.,aes(x=meansoiltemp,y=corr,color=measure))+geom_point()+
  geom_smooth(method="lm")+
  xlab("Mean soil temperature for May")+
  ylab("Correlation coef. air-soil temperature\nover May\n(based on daily mean/min/max temperatures)")+
  geom_text_repel(data=. %>% filter(corr<0),aes(label=pair))
```

Pairs with negative correlations: 63 (not for max), 66, 68, 71, 72 (not for min), 73.

Linear models testing the effect of soil temperature on correlations between soil and air temperature:

```{r message=FALSE, warning=FALSE}
(logger_data_pairs%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
  mutate(date=date(datetime))%>%
  filter(!is.na(date))%>%
  group_by(date,pair,above_below)%>%
  summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp))%>%
  pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
  group_by(pair)%>%
  summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
            corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
            corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"))%>%
   pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                names_to="measure",values_to="corr")%>%
  left_join(logger_data_pairs%>%
              mutate(month = month(datetime))%>%
  filter(month==5)%>%
  filter(above_below=="B")%>%
  group_by(pair)%>%
  summarise(meansoiltemp=mean(temp),dist=first(dist))))%>%
  group_by(measure)%>%
  do(fitcorr = tidy(lm(corr~meansoiltemp, data = .))) %>% 
  unnest(fitcorr)%>%
  kable()
```

Non-significant in all cases.

##### Based on 12-h (day) values

```{r message=FALSE, warning=FALSE, fig.height=4, fig.width=6}
(logger_data_pairs%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
   mutate(time=hour(datetime))%>%
     filter(time>8&time<=20)%>%
  mutate(date=date(datetime))%>%
  filter(!is.na(date))%>%
  group_by(date,pair,above_below)%>%
  summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp),
               plot=first(plot))%>%
  pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
  group_by(pair)%>%
  summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
            corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
            corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"),
            plot=first(plot))%>%
   pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                names_to="measure",values_to="corr")%>%
  left_join(logger_data_pairs%>%
              mutate(month = month(datetime))%>%
              filter(month==5)%>%
              mutate(time=hour(datetime))%>%
     filter(time>8&time<=20)%>%
              filter(above_below=="B")%>%
              group_by(pair)%>%
              summarise(meansoiltemp=mean(temp),dist=first(dist))))%>%
  # NAs for plots H11 and H15 --> no Belowground loggers
  ggplot(.,aes(x=meansoiltemp,y=corr,color=measure))+geom_point()+
  geom_smooth(method="lm")+
  xlab("Mean soil temperature for May")+
  ylab("Correlation coef. air-soil temperature\nover May\n(based on daily mean/min/max temperatures)")+
  geom_text_repel(data=. %>% filter(corr<0),aes(label=pair))
```

Linear models testing the effect of soil temperature on correlations between soil and air temperature:

```{r message=FALSE, warning=FALSE}
(logger_data_pairs%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
   mutate(time=hour(datetime))%>%
     filter(time>8&time<=20)%>%
  mutate(date=date(datetime))%>%
  filter(!is.na(date))%>%
  group_by(date,pair,above_below)%>%
  summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp))%>%
  pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
  group_by(pair)%>%
  summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
            corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
            corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"))%>%
   pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                names_to="measure",values_to="corr")%>%
  left_join(logger_data_pairs%>%
              mutate(month = month(datetime))%>%
  filter(month==5)%>%
    mutate(time=hour(datetime))%>%
     filter(time>8&time<=20)%>%
  filter(above_below=="B")%>%
  group_by(pair)%>%
  summarise(meansoiltemp=mean(temp),dist=first(dist))))%>%
  group_by(measure)%>%
  do(fitcorr = tidy(lm(corr~meansoiltemp, data = .))) %>% 
  unnest(fitcorr)%>%
  kable()
```

Non-significant in all cases.

##### Based on positive values

```{r message=FALSE, warning=FALSE, fig.height=4, fig.width=6}
(logger_data_pairs%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
  filter(temp>0)%>%
  mutate(date=date(datetime))%>%
  filter(!is.na(date))%>%
  group_by(date,pair,above_below)%>%
  summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp),
               plot=first(plot))%>%
  pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
  group_by(pair)%>%
  summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
            corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
            corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"),
            plot=first(plot))%>%
   pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                names_to="measure",values_to="corr")%>%
  left_join(logger_data_pairs%>%
              mutate(month = month(datetime))%>%
              filter(month==5)%>%
              filter(temp>0)%>%
              filter(above_below=="B")%>%
              group_by(pair)%>%
              summarise(meansoiltemp=mean(temp),dist=first(dist))))%>%
  # NAs for plots H11 and H15 --> no Belowground loggers
  ggplot(.,aes(x=meansoiltemp,y=corr,color=measure))+geom_point()+
  geom_smooth(method="lm")+
  xlab("Mean soil temperature for May")+
  ylab("Correlation coef. air-soil temperature\nover May\n(based on daily mean/min/max temperatures)")+
  geom_text_repel(data=. %>% filter(corr<0),aes(label=pair))
```

Linear models testing the effect of soil temperature on correlations between soil and air temperature:

```{r message=FALSE, warning=FALSE}
(logger_data_pairs%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
  filter(temp>0)%>%
  mutate(date=date(datetime))%>%
  filter(!is.na(date))%>%
  group_by(date,pair,above_below)%>%
  summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp))%>%
  pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
  group_by(pair)%>%
  summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
            corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
            corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"))%>%
   pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                names_to="measure",values_to="corr")%>%
  left_join(logger_data_pairs%>%
              mutate(month = month(datetime))%>%
  filter(month==5)%>%
  filter(temp>0)%>%
  filter(above_below=="B")%>%
  group_by(pair)%>%
  summarise(meansoiltemp=mean(temp),dist=first(dist))))%>%
  group_by(measure)%>%
  do(fitcorr = tidy(lm(corr~meansoiltemp, data = .))) %>% 
  unnest(fitcorr)%>%
  kable()
```

Non-significant in all cases.

### Analyses using pairs with distance \< 2

```{r}
logger_data_pairs_2<-subset(logger_data_pairs,dist<2)
```

#### Correlations soil-air temperature over the period April-May-June

For each date and logger pair, calculate mean, max and min of air and soil temperature (from, respectively, the above and belowground logger). Then, calculate the correlation coefficient for air and soil temperatures over the period April-May-June. Finally, regress these correlation coefficients on mean soil temperature (from the aboveground logger) **for the same period (April-May-June)**.

Using only data till June 5th, included (as most loggers stop on June 6th).

```{r message=FALSE, warning=FALSE, fig.height=4, fig.width=6}
(logger_data_pairs_2%>%
     mutate(month = month(datetime))%>%
     filter(month==4|month==5|month==6)%>%
     mutate(date=date(datetime))%>%
     filter(datetime<"2018-06-06")%>%
     filter(!is.na(date))%>%
     group_by(date,pair,above_below)%>%
     summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp),
               plot=first(plot))%>%
     pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
     group_by(pair)%>%
     summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
               corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
               corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"),
               plot=first(plot))%>%
     pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                  names_to="measure",values_to="corr")%>%
     left_join(logger_data_pairs_2%>%
                 mutate(month = month(datetime))%>%
                 filter(month==4|month==5|month==6)%>%
                 filter(datetime<"2018-06-06")%>%
                 filter(above_below=="B")%>%
                 group_by(pair)%>%
                 summarise(meansoiltemp=mean(temp),dist=first(dist))))%>%
  # NAs for plots H11 and H15 --> no Belowground loggers
  ggplot(.,aes(x=meansoiltemp,y=corr,color=measure))+geom_point()+
  geom_smooth(method="lm")+
  xlab("Mean soil temperature for April-May-June")+
  ylab("Correlation coef. air-soil temperature\nover April-May-June\n(based on daily mean/min/max temperatures)")+
  geom_text_repel(data=. %>% filter(corr<0),aes(label=pair))
```

Linear models testing the effect of soil temperature on correlations between soil and air temperature:

```{r message=FALSE, warning=FALSE}
(logger_data_pairs_2%>%
     mutate(month = month(datetime))%>%
     filter(month==4|month==5|month==6)%>%
     mutate(date=date(datetime))%>%
     filter(datetime<"2018-06-06")%>%
     filter(!is.na(date))%>%
     group_by(date,pair,above_below)%>%
     summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp),
               plot=first(plot))%>%
     pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
     group_by(pair)%>%
     summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
               corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
               corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"),
               plot=first(plot))%>%
     pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                  names_to="measure",values_to="corr")%>%
  left_join(logger_data_pairs_2%>%
                 mutate(month = month(datetime))%>%
                 filter(month==4|month==5|month==6)%>%
                 filter(datetime<"2018-06-06")%>%
                 filter(above_below=="B")%>%
                 group_by(pair)%>%
              summarise(meansoiltemp=mean(temp),dist=first(dist))))%>%
  group_by(measure)%>%
  do(fitcorr = tidy(lm(corr~meansoiltemp, data = .))) %>% 
  unnest(fitcorr)%>%
  kable()
```

Non-significant in all cases.

#### Correlations soil-air temperature for May only

For each date and logger pair, calculate mean, max and min of air and soil temperature (from, respectively, the above and belowground logger). Then, calculate the correlation coefficient for air and soil temperatures over the month of May. Finally, regress these correlation coefficients on mean soil temperature (from the aboveground logger) **for the same period (May)**.

```{r message=FALSE, warning=FALSE, fig.height=4, fig.width=6}
(logger_data_pairs_2%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
  mutate(date=date(datetime))%>%
  filter(!is.na(date))%>%
  group_by(date,pair,above_below)%>%
  summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp),
               plot=first(plot))%>%
  pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
  group_by(pair)%>%
  summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
            corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
            corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"),
            plot=first(plot))%>%
   pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                names_to="measure",values_to="corr")%>%
  left_join(logger_data_pairs_2%>%
              mutate(month = month(datetime))%>%
              filter(month==5)%>%
              filter(above_below=="B")%>%
              group_by(pair)%>%
              summarise(meansoiltemp=mean(temp),dist=first(dist))))%>%
  # NAs for plots H11 and H15 --> no Belowground loggers
  ggplot(.,aes(x=meansoiltemp,y=corr,color=measure))+geom_point()+
  geom_smooth(method="lm")+
  xlab("Mean soil temperature for May")+
  ylab("Correlation coef. air-soil temperature\nover May\n(based on daily mean/min/max temperatures)")+
  geom_text_repel(data=. %>% filter(corr<0),aes(label=pair))
```

Linear models testing the effect of soil temperature on correlations between soil and air temperature:

```{r message=FALSE, warning=FALSE}
(logger_data_pairs_2%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
  mutate(date=date(datetime))%>%
  filter(!is.na(date))%>%
  group_by(date,pair,above_below)%>%
  summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp))%>%
  pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
  group_by(pair)%>%
  summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
            corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
            corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"))%>%
   pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                names_to="measure",values_to="corr")%>%
  left_join(logger_data_pairs_2%>%
              mutate(month = month(datetime))%>%
  filter(month==5)%>%
  filter(above_below=="B")%>%
  group_by(pair)%>%
  summarise(meansoiltemp=mean(temp),dist=first(dist))))%>%
  group_by(measure)%>%
  do(fitcorr = tidy(lm(corr~meansoiltemp, data = .))) %>% 
  unnest(fitcorr)%>%
  kable()
```

Non-significant in all cases.

### Analyses using the 17 pairs where above- and belowground loggers are at the same plant

#### Correlations soil-air temperature over the period April-May-June

```{r message=FALSE, warning=FALSE, fig.height=4, fig.width=6}
(logger_data_pairs_2%>%
   filter(dist==0)%>%
     mutate(month = month(datetime))%>%
     filter(month==4|month==5|month==6)%>%
     mutate(date=date(datetime))%>%
     filter(datetime<"2018-06-06")%>%
     filter(!is.na(date))%>%
     group_by(date,pair,above_below)%>%
     summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp),
               plot=first(plot))%>%
     pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
     group_by(pair)%>%
     summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
               corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
               corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"),
               plot=first(plot))%>%
     pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                  names_to="measure",values_to="corr")%>%
     left_join(logger_data_pairs_2%>%
                 filter(dist==0)%>%
                 mutate(month = month(datetime))%>%
                 filter(month==4|month==5|month==6)%>%
                 filter(datetime<"2018-06-06")%>%
                 filter(above_below=="B")%>%
                 group_by(pair)%>%
                 summarise(meansoiltemp=mean(temp),dist=first(dist))))%>%
  # NAs for plots H11 and H15 --> no Belowground loggers
  ggplot(.,aes(x=meansoiltemp,y=corr,color=measure))+geom_point()+
  geom_smooth(method="lm")+
  xlab("Mean soil temperature for April-May-June")+
  ylab("Correlation coef. air-soil temperature\nover April-May-June\n(based on daily mean/min/max temperatures)")+
  geom_text_repel(data=. %>% filter(corr<0),aes(label=pair))
```

Linear models testing the effect of soil temperature on correlations between soil and air temperature:

```{r message=FALSE, warning=FALSE}
(logger_data_pairs_2%>%
   filter(dist==0)%>%
     mutate(month = month(datetime))%>%
     filter(month==4|month==5|month==6)%>%
     mutate(date=date(datetime))%>%
     filter(datetime<"2018-06-06")%>%
     filter(!is.na(date))%>%
     group_by(date,pair,above_below)%>%
     summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp),
               plot=first(plot))%>%
     pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
     group_by(pair)%>%
     summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
               corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
               corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"),
               plot=first(plot))%>%
     pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                  names_to="measure",values_to="corr")%>%
  left_join(logger_data_pairs_2%>%
              filter(dist==0)%>%
                 mutate(month = month(datetime))%>%
                 filter(month==4|month==5|month==6)%>%
                 filter(datetime<"2018-06-06")%>%
                 filter(above_below=="B")%>%
                 group_by(pair)%>%
              summarise(meansoiltemp=mean(temp),dist=first(dist))))%>%
  group_by(measure)%>%
  do(fitcorr = tidy(lm(corr~meansoiltemp, data = .))) %>% 
  unnest(fitcorr)%>%
  kable()
```

Postive relationships are significant in all cases!

#### Correlations soil-air temperature for May only

```{r message=FALSE, warning=FALSE, fig.height=4, fig.width=6}
(logger_data_pairs_2%>%
   filter(dist==0)%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
  mutate(date=date(datetime))%>%
  filter(!is.na(date))%>%
  group_by(date,pair,above_below)%>%
  summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp),
               plot=first(plot))%>%
  pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
  group_by(pair)%>%
  summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
            corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
            corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"),
            plot=first(plot))%>%
   pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                names_to="measure",values_to="corr")%>%
  left_join(logger_data_pairs_2%>%
              filter(dist==0)%>%
              mutate(month = month(datetime))%>%
              filter(month==5)%>%
              filter(above_below=="B")%>%
              group_by(pair)%>%
              summarise(meansoiltemp=mean(temp),dist=first(dist))))%>%
  # NAs for plots H11 and H15 --> no Belowground loggers
  ggplot(.,aes(x=meansoiltemp,y=corr,color=measure))+geom_point()+
  geom_smooth(method="lm")+
  xlab("Mean soil temperature for May")+
  ylab("Correlation coef. air-soil temperature\nover May\n(based on daily mean/min/max temperatures)")+
  geom_text_repel(data=. %>% filter(corr<0),aes(label=pair))
```

Linear models testing the effect of soil temperature on correlations between soil and air temperature:

```{r message=FALSE, warning=FALSE}
(logger_data_pairs_2%>%
   filter(dist==0)%>%
  mutate(month = month(datetime))%>%
  filter(month==5)%>%
  mutate(date=date(datetime))%>%
  filter(!is.na(date))%>%
  group_by(date,pair,above_below)%>%
  summarise(mean=mean(temp,na.rm=T),max=max(temp),min=min(temp))%>%
  pivot_wider(names_from="above_below",values_from=c("mean","max","min"))%>%
  group_by(pair)%>%
  summarise(corr_airsoil_mean=cor(mean_A,mean_B,use="pairwise.complete.obs"),
            corr_airsoil_max=cor(max_A,max_B,use="pairwise.complete.obs"),
            corr_airsoil_min=cor(min_A,min_B,use="pairwise.complete.obs"))%>%
   pivot_longer(cols=corr_airsoil_mean:corr_airsoil_min,
                names_to="measure",values_to="corr")%>%
  left_join(logger_data_pairs_2%>%
              filter(dist==0)%>%
              mutate(month = month(datetime))%>%
  filter(month==5)%>%
  filter(above_below=="B")%>%
  group_by(pair)%>%
  summarise(meansoiltemp=mean(temp),dist=first(dist))))%>%
  group_by(measure)%>%
  do(fitcorr = tidy(lm(corr~meansoiltemp, data = .))) %>% 
  unnest(fitcorr)%>%
  kable()
```

Significant only for min, near significance for the others. 
